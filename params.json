{"name":"Pigato","tagline":"PIGATO - an high-performance microservices framework based on ZeroMQ","body":"PIGATO\r\n========\r\n\r\n[![PIGATO](http://ardoino.com/pub/pigato-200.png)](https://github.com/prdn/pigato)\r\n\r\n**PIGATO - an high-performance Node.js microservices framework based on ZeroMQ**\r\n\r\nPIGATO aims to offer an high-performance, reliable, scalable and extensible service-oriented framework supporting multiple programming languages: Node.js/Io.js and Ruby.\r\n\r\n[![Travis Build Status](https://travis-ci.org/prdn/pigato.svg?style=flat)](https://travis-ci.org/prdn/pigato)\r\n[![NPM version](http://img.shields.io/npm/v/pigato.svg?style=flat)](https://www.npmjs.com/package/pigato)\r\n\r\n**Supported Programming Languages**\r\n\r\n* [PIGATO](https://github.com/prdn/pigato) : PIGATO Client/Worker/Broker for Node.js / Io.js\r\n* [PIGATO-RUBY](https://github.com/prdn/pigato-ruby) : PIGATO Client/Worker for Ruby\r\n\r\n\r\n## Structure and Protocol\r\n\r\n### Actors\r\n* Worker : receives requests, does something and replies. A Worker offers a Service, should be a functionality as atomic as possible\r\n* Client : creates, pushes Requests and waits for results. A request always includes a service name and data for the Worker\r\n* Broker : handles Requests queueing and routing\r\n\r\n### Benefits\r\n* High-performance\r\n* Realiable, Distributed and Scalable\r\n* Load Balancing\r\n* No central point of failure\r\n* Multi-Worker : infinite Services and infinite Workers for each Service\r\n* Multi-Client : infinite Clients\r\n* Multi-Broker : infinite Brokers to avoid bottlenecks and improve network reliability\r\n\r\n### Features\r\n* Request / Reply protocol\r\n* Support for partial Replies\r\n* Client concurrent Requests\r\n* Client streaming Requests\r\n* Worker concurrent Requests\r\n* Worker dynamic load balancing\r\n* Client heartbeating for long running requests. Allows Workers to dected whenever Clients disconnect or lose interest in some request. This feature is very useful to stop long-running partial requests (i.e data streaming).\r\n\r\n## Examples\r\n\r\nStart a **Broker**\r\n```\r\nnode examples/broker\r\n```\r\n\r\n1) **echo** : simple echo request-reply\r\n```\r\nnode examples/echo/worker\r\nnode examples/echo/client\r\n```\r\n\r\n2) **stocks** : get stocks data from yahoo\r\n```\r\nnode examples/echo/worker\r\nnode examples/echo/client\r\n```\r\n\r\n\r\nMore examples\r\n\r\n[PIGATO-EXAMPLES](https://github.com/fincluster/pigato-examples) : a collection of multi-purpose useful examples.\r\n\r\n### Performance\r\n\r\n[PIGATO-PERF](https://github.com/prdn/pigato-perf) : a command-line tool to test PIGATO performances in different scenarios.\r\n\r\n## API\r\n\r\n### Broker\r\n#### `PIGATO.Broker(addr, conf)`\r\n* `addr` - Broker address (string, i.e: 'tcp://*:12345') \r\n* `conf` - configuration override (type=object, i.e { concurrency: 20 })\r\n  * `onStart`: function to be called when the Broker start \r\n  * `onStop`: function to be called when the Broker stop\r\n\r\nSimply starts up a broker.\r\n\r\n```\r\nvar Broker = require('./../index').Broker;\r\n\r\nvar broker = new Broker(\"tcp://*:55555\");\r\nbroker.start(function() {\r\n  console.log(\"Broker started\");\r\n});\r\n```\r\n\r\n#### Events\r\n* `start` : on Client start\r\n* `stop` : on Client stop\r\n\r\n### Worker\r\n#### `PIGATO.Worker(addr, serviceName, conf)`\r\n* `addr` - Broker address (type=string, i.e: 'tcp://localhost:12345') \r\n* `serviceName` - service implemented by the Worker (type=string, i.e: 'echo')\r\n  * wildcards * are supported (i.e: 'ech*')\r\n* `conf` - configuration override (type=object, i.e { concurrency: 20 })\r\n  * `concurrency` - sets max number of concurrent requests (type=int, -1 = no limit)\r\n  * `onConnect`: function to be called when the Worker connects to the Broker\r\n  * `onDisconnnect`: function to be called when the Worker disconnects from the Broker\r\n\r\n#### Methods\r\n\r\n##### `on`\r\nWorker receives `request` events with 2 arguments:\r\n* `data` - data sent from the Client (type=string/object/array).\r\n* `reply` - extended writable stream (type=object)\r\n\r\n`reply` writable stream exposes also following methods and attributes:\r\n\r\n* `write()` - sends partial data to the Client \r\n* `end()` - sends last data to the Client and completes/closes current Request\r\n* `reject()` - rejects a Request.\r\n* `heartbeat()` - forces sending heartbeat to the Broker\r\n* `active()` - returns the status of the Request (type=boolean). A Request becomes inactive when the Worker disconnects from the Broker or it has been discarded by the Client or the Client disconnects from the Broker. This is useful for long running tasks so the Worker can monitor whether or not continue processing a Request.\r\n* `ended` - tells if the Request has been ended (type=boolean).\r\n\r\n**Example**\r\n\r\n```\r\nvar worker = new PIGATO.Worker('tcp://localhost:12345', 'my-service');\r\nworker.start();\r\n\r\nworker.on('request', function(data, reply) {\r\n  for (var i = 0; i < 1000; i++) {\r\n    reply.write('PARTIAL DATA ' + i);\r\n  }\r\n  reply.end('FINAL DATA');\r\n});\r\n\r\n// or\r\nworker.on('request', function(data, reply) {\r\n  fs.createReadStream(data).pipe(reply);\r\n});\r\n\r\n```\r\n\r\nWorker may also specify whether the reply should be cached and the cache timeout in milliseconds \r\n\r\n**Example**\r\n\r\n```\r\nworker.on('request', function(data, reply) {\r\n  reply.opts.cache = 1000; // cache reply for 1 second\r\n  reply.end('FINAL DATA');\r\n});\r\n```\r\n\r\nWorker can change concurrency level updating its configuration. This information is carried with the heartbeat message.\r\n\r\n**Example**\r\n\r\n```\r\nworker.conf.concurrency = 2;\r\n```\r\n\r\nTake note: due to the framing protocol of `zmq` only the data supplied to `response.end(data)` will be given to the client's final callback.\r\n\r\n#### Events\r\n* `start` : on Worker start\r\n* `stop` : on Worker stop\r\n* `connect` : on Worker connect\r\n* `disconnect` : on Worker disconnect\r\n\r\n\r\n### Client\r\n#### `PIGATO.Client(addrs)`\r\n* `addrs` - list of Broker addresses (array)\r\n* `conf`\r\n  * `autostart`: automatically starts the Client (type=boolean, default=false)\r\n  * `onConnect`: function to be called when the Client connects to the Broker\r\n  * `onDisconnnect`: function to be called when the Client disconnects from the Broker\r\n\r\n#### Methods\r\n\r\n##### `start`\r\n\r\nStart the Client\r\n\r\n##### `request`\r\n\r\nSend a Request\r\n\r\n* `serviceName` - name of the Service we wish to connect to (type=string)\r\n* `data` - data to give to the Service (type=string/object/buffer)\r\n* `opts` - options for the Request (type=object)\r\n  * `timeout`: timeout in milliseconds (type=number, default=60000, -1 for infinite timeout)\r\n  * `retry`: if a Worker dies before replying, the Request is automatically requeued. (type=number, values=0|1, default=0)\r\n  * `nocache`: skip Broker's cache\r\n  * `workerId`: ID of the Worker that must handle the Request (type=string)\r\n\r\n\r\n**Example**\r\n\r\n```\r\nvar client = new PIGATO.Client('tcp://localhost:12345');\r\nclient.start()\r\n\r\nclient.request('my-service', { foo: 'bar' }, { timeout: 120000 })\r\n.on('data', function(data) {\r\n  console.log(\"DATA\", data);\t\r\n})\r\n.on('end', function() {\r\n  console.log(\"END\");\t  \r\n});\r\n\r\n// or\r\nclient.request('my-service', 'foo', { timeout: 120000 }).pipe(process.stdout);\r\n```\r\n\r\nClients may also make request with partial and final callbacks instead of using streams.\r\n\r\n* `serviceName`\r\n* `data`\r\n* `partialCallback(err, data)` - called whenever the request does not end but emits data\r\n* `finalCallback(err, data)` - called when the request will emit no more data\r\n* `opts`\r\n\r\n**Example**\r\n\r\n```\r\nclient.request('my-service', 'foo', function (err, data) {\r\n  // frames sent prior to final frame\r\n  console.log('PARTIAL', data);\r\n}, function (err, data) {\r\n  // this is the final frame sent\r\n  console.log('FINAL', data);\r\n}, { timeout: 30000 });\r\n\r\n```\r\n\r\n#### Events\r\n* `start` : on Client start\r\n* `stop` : on Client stop\r\n* `connect` : on Client connect\r\n* `disconnect` : on Client disconnect\r\n\r\n### Core Services\r\nCore services are a set of Services that interact with a Broker via a dedicated PUB/SUB channel to extend its core functionalities.\r\n\r\n#### Initialization\r\n\r\n```\r\nvar broker = new PIGATO.Broker(bhost);\r\nvar csrv = new PIGATO.services.ExampleCoreService(bhost, {\r\n  intch: broker.conf.intch // internal pub/sub channel                  \r\n});\r\nbroker.start();\r\ncsrv.start();\r\n```\r\n\r\n#### Directory\r\n##### `PIGATO.services.Directory`\r\n\r\nDirectory service ($dir) replies to Requests with the list of available Workers for a selected service. \r\n\r\n**Example**\r\n\r\n```\r\n// Broadcast a message to all Workers that offer 'echo' Service\r\nclient.request(\r\n  '$dir', 'echo', undefined, \r\n  function(err, workers) {\r\n    workers.forEach(function(wid) {\r\n      client.request('echo', 'foo', { workerId: wid });\r\n    });\r\n  }\r\n);\r\n```\r\n\r\n### Notes\r\n* when using a `inproc` socket the broker *must* become active before any queued messages.\r\n\r\n## Specification (good for RFC)\r\n* Worker <-> Broker heartbeating.\r\n* Broker tracks Worker/Client/Request relation.\r\n* Client MAY send heartbeat for active request. If the request is being processed by Worker, Broker forwards heartbeat to Worker. \r\n* Worker MAY decide to stop an inactive Request (tracks liveness for Request).\r\n* Client MAY assign a timeout to a Request.\r\n* Worker SHALL NOT send more W_REPLY (for a Request) after sending first W_REPLY message.\r\n* Broker SHALL force disconnect Worker if any error occurs.\r\n\r\n## Protocol\r\n\r\n#### Common\r\n* Frame 0: Side tag (MDP.CLIENT/MDP.WORKER)\r\n* Frame 1: Message type (MDP.W_REQUEST, MDP.W_REPLY, MDP.W_REPLY_REJECT, ...)\r\n* Frame 2: Service name\r\n* Frame 3: Request ID (uuid)\r\n\r\n#### Client request\r\n* Frame 4: JSON encode request data\r\n* Frame 5: JSON encode request options\r\n\r\n#### Worker reply\r\n* Frame 4: Numeric status (0=OK, -1=ERROR)\r\n* Frame 5: JSON encode request data / error\r\n* Frame 6: JSON encode request options\r\n\r\n## Changelog\r\n\r\n[CHANGELOG](CHANGELOG.md)\r\n\r\n## Roadmap\r\n* Add authentication support through [zmq-zap](https://github.com/msealand/zmq-zap.node) ZeroMQ ZAP to trust Clients and Workers.\r\n\r\n## Follow me\r\n\r\n* Fincluster - cloud financial investments platform : [fincluster](https://fincluster.com) /  [@fincluster](https://twitter.com/fincluster)\r\n* My personal blog : [ardoino.com](http://ardoino.com) / [@paoloardoino](https://twitter.com/paoloardoino)\r\n\r\n## Contributors\r\n* [bmeck](https://github.com/bmeck)\r\n* [maxired](https://github.com/maxired)\r\n* [leonpegg](https://github.com/leonpegg)\r\n","google":"UA-3547313-4","note":"Don't delete this file! It's used internally to help with page regeneration."}