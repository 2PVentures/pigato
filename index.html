<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Pigato by prdn</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Pigato</h1>
        <p>PIGATO - a microservices framework for Node.js based on ZeroMQ</p>

        <p class="view"><a href="https://github.com/prdn/pigato">View the Project on GitHub <small>prdn/pigato</small></a></p>


        <ul>
          <li><a href="https://github.com/prdn/pigato/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/prdn/pigato/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/prdn/pigato">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h1>
<a id="pigato" class="anchor" href="#pigato" aria-hidden="true"><span class="octicon octicon-link"></span></a>PIGATO</h1>

<p><a href="https://github.com/prdn/pigato"><img src="http://ardoino.com/pub/pigato-200.png" alt="PIGATO"></a></p>

<p><strong>PIGATO - a microservices framework for Node.js based on ZeroMQ</strong></p>

<p>The goal is to offer a reliable and extensible service-oriented request-reply inspired by <a href="http://rfc.zeromq.org/spec:7">Majordomo Protocol (MDP) v0.2</a> and <a href="http://rfc.zeromq.org/spec:9">Titanic Service Protocol</a>. </p>

<h4>
<a id="structure" class="anchor" href="#structure" aria-hidden="true"><span class="octicon octicon-link"></span></a>Structure</h4>

<ul>
<li>Worker : receives requests, does something and replies. A worker offers a service, should be a functionality as atomic as possible</li>
<li>Client : creates, pushes requests and waits for results (if needed). A request always includes a service and a payload/data for the Worker</li>
<li>Broker : handles requests queueing and routing</li>
</ul>

<h4>
<a id="examples" class="anchor" href="#examples" aria-hidden="true"><span class="octicon octicon-link"></span></a>Examples</h4>

<p>Start a <strong>Broker</strong></p>

<pre><code>node examples/broker
</code></pre>

<p>1) <strong>echo</strong> : simple echo request-reply</p>

<pre><code>node examples/echo/worker
node examples/echo/client
</code></pre>

<p>2) <strong>stocks</strong> : get stocks data from yahoo</p>

<pre><code>node examples/echo/worker
node examples/echo/client
</code></pre>

<p>More examples</p>

<p><a href="https://github.com/fincluster/pigato-examples">PIGATO-EXAMPLES</a> : a collection of multi-purpose useful examples.</p>

<h4>
<a id="performance" class="anchor" href="#performance" aria-hidden="true"><span class="octicon octicon-link"></span></a>Performance</h4>

<p><a href="https://github.com/prdn/pigato-perf">PIGATO-PERF</a> : a command-line tool to test PIGATO performances in different scenarios.</p>

<h3>
<a id="api" class="anchor" href="#api" aria-hidden="true"><span class="octicon octicon-link"></span></a>API</h3>

<h4>
<a id="pigatobrokeraddr" class="anchor" href="#pigatobrokeraddr" aria-hidden="true"><span class="octicon octicon-link"></span></a><code>pigato.Broker(addr)</code>
</h4>

<ul>
<li>
<code>addr</code> - Broker address (string, i.e: 'tcp://*:12345') </li>
</ul>

<p>Simply starts up a broker.</p>

<pre><code>var Broker = require('./../index').Broker;

var broker = new Broker("tcp://*:55555");
broker.start(function(){});
</code></pre>

<h4>
<a id="pigatoworkeraddr-servicename" class="anchor" href="#pigatoworkeraddr-servicename" aria-hidden="true"><span class="octicon octicon-link"></span></a><code>pigato.Worker(addr, serviceName)</code>
</h4>

<ul>
<li>
<code>addr</code> - Broker address (string, i.e: 'tcp://localhost:12345') </li>
<li>
<code>serviceName</code> - service implemented by the Worker (string, i.e: 'echo')</li>
</ul>

<p>Worker receives <code>"request"</code> events with 2 arguments:</p>

<ul>
<li>
<code>data</code> - value sent by a client for this request.</li>
<li>
<code>reply</code> - extended writable stream to send data to the client.</li>
</ul>

<p><code>reply</code> writable stream exposes also following methods and attributes:</p>

<ul>
<li>
<code>write()</code> - sends partial data to the client (triggers partial callback). It is used internally to implement writable streams.</li>
<li>
<code>end()</code> - sends last data to the client (triggers final callback) and completes/closes current request. Use this method for single-reply requests.</li>
<li>
<code>reject()</code> - rejects a request.</li>
<li>
<code>heartbeat()</code> - forces sending heartbeat to the broker and client</li>
<li>
<code>active()</code> - returns (boolean) the status of the request. A request becomes inactive when the worker disconnects from the broker or it is discarded by the client or the client disconnects from the broker. This is useful for long running tasks and Worker can monitor whether or not continue processing a request.</li>
<li>
<code>ended</code> - tells (boolean) if the request has been ended.</li>
</ul>

<p>Example:</p>

<pre><code>var worker = new PIGATO.Worker('tcp://localhost:12345', 'my-service');

worker.on('request', function(data, reply) {
  fs.createReadStream(data).pipe(reply);
});

// or
worker.on('request', function(data, reply) {
  for (var i = 0; i &lt; 1000; i++) {
    reply.write('PARTIAL DATA ' + i);
  }
  reply.end('FINAL DATA');
});
</code></pre>

<p>Worker may also specify whether the reply should be cached and the cache timeout in milliseconds </p>

<p>Example:</p>

<pre><code>worker.on('request', function(data, reply) {
  reply.opts.cache = 1000; // cache reply for 1 second
  reply.end('FINAL DATA');
});
</code></pre>

<p>Take note: due to the framing protocol of <code>zmq</code> only the data supplied to <code>response.end(data)</code> will be given to the client's final callback.</p>

<h4>
<a id="pigatoclientaddrs" class="anchor" href="#pigatoclientaddrs" aria-hidden="true"><span class="octicon octicon-link"></span></a><code>PIGATO.Client(addrs)</code>
</h4>

<ul>
<li>
<code>addrs</code> - list of Broker addresses (array)</li>
</ul>

<p>Clients may make requests using <code>Client.request(...)</code> method.</p>

<ul>
<li>
<code>serviceName</code> - name of the service we wish to connect to</li>
<li>
<code>data</code> - data to give to the service (string/object/buffer)</li>
<li>
<code>opts</code> - options object for the request</li>
</ul>

<p>Example:</p>

<pre><code>var client = new PIGATO.Client('tcp://localhost:12345');

client.request('my-service', 'foo', { timeout: 120000 }).pipe(process.stdout);

// or
client.request('my-service', { foo: 'bar' }, { timeout: 120000 })
.on('data', function(data) {
  console.log("DATA", data);    
})
.on('end', function() {
  console.log("END");     
});
</code></pre>

<p>Clients may also make request with partial and final callbacks instead of using streams.</p>

<ul>
<li><code>serviceName</code></li>
<li><code>data</code></li>
<li>
<code>partialCallback(err, data)</code> - called whenever the request does not end but emits data</li>
<li>
<code>finalCallback(err, data)</code> - called when the request will emit no more data</li>
<li><code>opts</code></li>
</ul>

<p>Example:</p>

<pre><code>client.request('my-service', 'foo', function (err, data) {
  // frames sent prior to final frame
  console.log('PARTIAL', data);
}, function (err, data) {
  // this is the final frame sent
  console.log('FINAL', data);
}, { timeout: 30000 });

</code></pre>

<h5>
<a id="request-options" class="anchor" href="#request-options" aria-hidden="true"><span class="octicon octicon-link"></span></a>Request options</h5>

<ul>
<li>
<code>timeout</code> : default 60000 (60 seconds). Set -1 to disable (time unlimited request)</li>
</ul>

<h4>
<a id="notes" class="anchor" href="#notes" aria-hidden="true"><span class="octicon octicon-link"></span></a>Notes</h4>

<ul>
<li>when using a <code>inproc</code> socket the broker <em>must</em> become active before any queued messages.</li>
</ul>

<h3>
<a id="protocol" class="anchor" href="#protocol" aria-hidden="true"><span class="octicon octicon-link"></span></a>Protocol</h3>

<h4>
<a id="benefits" class="anchor" href="#benefits" aria-hidden="true"><span class="octicon octicon-link"></span></a>Benefits</h4>

<ul>
<li>Reliable request / reply protocol</li>
<li>Scalability</li>
<li>Multi-Worker : infinite services and infinite workers for each service</li>
<li>Multi-Client : infinite clients</li>
<li>Multi-Broker : infinite brokers to avoid bottlenecks and improve network reliability</li>
</ul>

<h4>
<a id="features" class="anchor" href="#features" aria-hidden="true"><span class="octicon octicon-link"></span></a>Features</h4>

<ul>
<li>Compatibility with MDP protocol v0.2 .</li>
<li>Support for partial replies.</li>
<li>Client multi-request support.</li>
<li>Client heartbeating for long running requests. Allows Workers to dected whenever Clients disconnect or lose interest in some request. This feature is very useful to stop long-running partial requests (i.e data streaming).</li>
</ul>

<h4>
<a id="specification-good-for-rfc" class="anchor" href="#specification-good-for-rfc" aria-hidden="true"><span class="octicon octicon-link"></span></a>Specification (good for RFC)</h4>

<ul>
<li>Worker &lt;-&gt; Broker heartbeating.</li>
<li>Broker MAY track Worker/Client/Request relation.</li>
<li>Client MAY send heartbeat for active request. If the request is being processed by Worker, Broker forwards heartbeat to Worker. </li>
<li>Worker MAY decide to stop an inactive Request (tracks liveness for Request).</li>
<li>Client MAY assign a timeout to a Request.</li>
<li>Worker SHALL NOT send more W_REPLY (for a Request) after sending first W_REPLY message.</li>
<li>Broker SHALL force disconnect Broker if any error occurs.</li>
</ul>

<h4>
<a id="roadmap" class="anchor" href="#roadmap" aria-hidden="true"><span class="octicon octicon-link"></span></a>Roadmap</h4>

<ul>
<li>Add authentication support through <a href="https://github.com/msealand/zmq-zap.node">zmq-zap</a> ZeroMQ ZAP to trust Clients and Workers.</li>
<li>Support <a href="http://rfc.zeromq.org/spec:9">Titanic Service Protocol</a> for peristent requests.</li>
</ul>

<h4>
<a id="follow-me" class="anchor" href="#follow-me" aria-hidden="true"><span class="octicon octicon-link"></span></a>Follow me</h4>

<ul>
<li>Fincluster - cloud financial platform : <a href="http://fincluster.com">fincluster</a> /  <a href="https://twitter.com/fincluster">@fincluster</a>
</li>
<li>My personal blog : <a href="http://ardoino.com">ardoino.com</a> / <a href="https://twitter.com/paoloardoino">@paoloardoino</a>
</li>
</ul>

<h4>
<a id="contributors" class="anchor" href="#contributors" aria-hidden="true"><span class="octicon octicon-link"></span></a>Contributors</h4>

<ul>
<li><a href="https://github.com/bmeck">bmeck</a></li>
</ul>

<h4>
<a id="credits" class="anchor" href="#credits" aria-hidden="true"><span class="octicon octicon-link"></span></a>Credits</h4>

<p>Based on <a href="https://github.com/nuh-temp/zmq-mdp2">https://github.com/nuh-temp/zmq-mdp2</a> project</p>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/prdn">prdn</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-3547313-4");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>